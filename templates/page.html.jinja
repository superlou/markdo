{% extends "base.html.jinja" %}
{% block content %}
    <div class="container">
        {% macro render_children(children) %}
            {% for child in children %}
                {% set child_class = child.__class__.__name__ %}
                {% if child_class == "Section" %}
                    {{section(child)}}
                {% elif child_class == "Note" %}
                    {{note(child)}}
                {% elif child_class == "Task" %}
                    {{task(child)}}                
                {% endif %}
            {% endfor %}
        {%- endmacro %}

        {% macro note(n) %}
            <p>{{n.text}}</p>
        {%- endmacro %}

        {% macro subtasks_badge(t) %}
            {% if t.subtasks() | length > 0 %}
                {% set no_open_subtasks = t.subtasks(open=True) | length == 0 %}
                <span class="badge rounded-pill {{'text-bg-success' if no_open_subtasks else 'text-bg-primary'}}">
                    {{t.subtasks(open=False) | length }}/{{t.subtasks() | length }}
                </span>
            {% endif %}
        {%- endmacro %}

        {% macro task(t) %}
            <div class="task task-open-{{t.is_open}}">
                <div class="task-heading">
                    <a href="edit/L{{t.line_num}}/anchor/{{t.line_num}}" class="edit">
                        <span class="open-task-box">‚òê</span>
                        {{subtasks_badge(t)}}
                        {{t.title}}
                    </a>
                </div>

                <div class="task-children">
                    {{render_children(t.children)}}
                </div>
            </div>
        {%- endmacro %}

        {% macro section(s) %}
            <h{{s.level}} id="{{s.line_num}}" class="section-heading">
                <a href="edit/L{{s.line_num}}/anchor/{{s.line_num}}" class="edit">{{s.title}}</a>
            </h{{s.level}}>

            {{render_children(s.children)}}
        {%- endmacro %}

        {{render_children(root.children)}}
    </div>
{% endblock %}